!function(e){function n(o){if(t[o])return t[o].exports;var r=t[o]={exports:{},id:o,loaded:!1};return e[o].call(r.exports,r,r.exports,n),r.loaded=!0,r.exports}var t={};return n.m=e,n.c=t,n.p="",n(0)}([function(e,n,t){"use strict";function o(e){var n="remote-video-"+e,t=document.getElementById(n);return t}function r(e){Q.unshift(e)}function i(){var e=null;return 0!=Q.lenght?(e=Q[0],Q.splice(0,1),e):null}function c(e,n){K[e]=n}function a(e){var n=null;return n=K[e],delete K[e],n}function s(e,n){var t=i();t?(navigator.mozGetUserMedia?(t.mozSrcObject=n,t.play()):t.src=G.createObjectURL(n),c(e,t)):console.error("---没有可用的video元素")}function d(e){console.log("尝试移除video. id="+e);var n=a(e);n?(n.pause(),n.src="",console.log("videoElement.src="+n.src),r(n)):console.warn("警告 --- 没有id为"+e+"的video元素")}function u(){for(var e in K)d(e)}function l(){return!!F}function f(){}function p(e){var n=null;return n=X[e]}function v(e,n){X[e]=n}function m(){var e=0;for(var n in X)e++;return console.log("getConnectionCount="+e),e}function g(){return m()<W}function h(){for(var e in X){var n=X[e];n.peerconnection.close(),n.peerconnection=null,delete X[e]}}function w(e){var n=X[e];n?(n.peerconnection.close(),n.peerconnection=null,delete X[e]):console.log("尝试停止连接,但是没有找到id为"+e+"的连接")}function y(){return m()>0}function b(e){console.log("已建立socket连接"),Y=!0;var n=L();$.emit("enter",n),console.log("进入房间"+n)}function R(e){var n=e.from,t=(e.sendto,p(n));if("call"===e.type){if(!l())return;if(t)return;if(Z)return;return g()?void $.json.send({type:"response",sendto:n}):void console.warn("已达到最大连接数，因此本连接被忽略")}return"response"===e.type?void M(n):void("offer"===e.type?x(e):"answer"===e.type&&y()?U(e):"candidate"===e.type&&y()?E(e):"bye"===e.type&&X[n]?C(n):"disconnect"===e.type&&X[n]&&C(n))}function C(e){d(e),w(e)}function L(){var e=document.location.href,n=e.split("?");if(n.length>1){var t=n[1];if(""!=t)return t}return"defaultroom"}function x(e){T(e),I(e)}function U(e){A(e)}function E(e){var n=e.from,t=p(n);if(!t)return void console.error("peerConnection不存在!");if(!t.iceReady)return void console.warn("ice尚未准备好");var o=new J(e);t.peerconnection.addIceCandidate(o)}function j(e,n){var t={};t.sdp=e,t.type=e.type,t.sendto=n,$.json.send(t)}function k(e){$.json.send(e)}function O(){N.call(navigator,{video:!0,audio:!1},function(e){F=e,q.src=G.createObjectURL(e),q.play(),q.volume=0},function(e){console.error("发生了一个错误: [错误代码： "+e.code+"]"),alert("打开视频时发生了错误!")})}function S(){q.src="",history.go(0)}function B(e){function n(e){s(this.id,e.stream)}function t(e){console.log("移除远程视频流"),d(this.id)}var o=new f,r={iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"stun:203.183.172.196:3478"}]};try{o.peerconnection=new P(r)}catch(e){console.log("建立连接失败，错误："+e.message)}o.id=e;var i=o.peerconnection;return i.id=e,v(e,o),i.addStream(F),i.onicecandidate=function(e){e.candidate?k({type:"candidate",sendto:o.id,label:e.candidate.sdpMLineIndex,candidate:e.candidate.candidate}):o.established=!0},i.addEventListener("addstream",n,!1),i.addEventListener("removestream",t,!1),o}function M(e){var n=B(e);n.peerconnection.createOffer(function(t){n.iceReady=!0,n.peerconnection.setLocalDescription(t),j(t,e)},function(){console.log("创建Offer失败")},H),n.iceReady=!0}function T(e){var n=e.from,t=e.sdp,o=B(n);o.peerconnection.setRemoteDescription(new V(t))}function I(e){var n=e.from,t=p(n);return t?(t.peerconnection.createAnswer(function(e){t.iceReady=!0,t.peerconnection.setLocalDescription(e),j(e,n)},function(){console.log("创建Answer失败")},H),void(t.iceReady=!0)):void console.error("peerConnection不存在!")}function A(e){var n=e.from,t=e.sdp,o=p(n);return o?void o.peerconnection.setRemoteDescription(new V(t)):void console.error("peerConnection不存在!")}function z(){return l()?Y?void(0===m()&&(console.log("呼叫同房间内的其他人"),Z=!1,$.json.send({type:"call"}))):void alert("尚未与Socket服务器建立连接"):void alert("请先捕捉本地视频")}function D(){console.log("挂断"),Z=!0,$.json.send({type:"bye"}),u(),h()}t(7);var N=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,G=window.URL||window.webkitURL||window.msURL||window.oURL,P=window.PeerConnection||window.webkitPeerConnection00||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,J=window.mozRTCIceCandidate||window.RTCIceCandidate,V=window.mozRTCSessionDescription||window.RTCSessionDescription;document.getElementById("startvideo").addEventListener("click",O,!1),document.getElementById("stopvideo").addEventListener("click",S,!1),document.getElementById("call").addEventListener("click",z,!1),document.getElementById("hangup").addEventListener("click",D,!1);var q=document.getElementById("local-video"),F=null,H={mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!0}},K={},Q=[];r(o(2)),r(o(1)),r(o(0));var W=3,X={},Y=!1,Z=!0,$=io.connect(window.location.href.split("/webrtcvideo")[0]+"/");$.on("connect",b).on("message",R)},function(e,n){e.exports=function(){var e=[];return e.toString=function(){for(var e=[],n=0;n<this.length;n++){var t=this[n];t[2]?e.push("@media "+t[2]+"{"+t[1]+"}"):e.push(t[1])}return e.join("")},e.i=function(n,t){"string"==typeof n&&(n=[[null,n,""]]);for(var o={},r=0;r<this.length;r++){var i=this[r][0];"number"==typeof i&&(o[i]=!0)}for(r=0;r<n.length;r++){var c=n[r];"number"==typeof c[0]&&o[c[0]]||(t&&!c[2]?c[2]=t:t&&(c[2]="("+c[2]+") and ("+t+")"),e.push(c))}},e}},function(e,n,t){function o(e,n){for(var t=0;t<e.length;t++){var o=e[t],r=p[o.id];if(r){r.refs++;for(var i=0;i<r.parts.length;i++)r.parts[i](o.parts[i]);for(;i<o.parts.length;i++)r.parts.push(d(o.parts[i],n))}else{for(var c=[],i=0;i<o.parts.length;i++)c.push(d(o.parts[i],n));p[o.id]={id:o.id,refs:1,parts:c}}}}function r(e){for(var n=[],t={},o=0;o<e.length;o++){var r=e[o],i=r[0],c=r[1],a=r[2],s=r[3],d={css:c,media:a,sourceMap:s};t[i]?t[i].parts.push(d):n.push(t[i]={id:i,parts:[d]})}return n}function i(e,n){var t=g(),o=y[y.length-1];if("top"===e.insertAt)o?o.nextSibling?t.insertBefore(n,o.nextSibling):t.appendChild(n):t.insertBefore(n,t.firstChild),y.push(n);else{if("bottom"!==e.insertAt)throw new Error("Invalid value for parameter 'insertAt'. Must be 'top' or 'bottom'.");t.appendChild(n)}}function c(e){e.parentNode.removeChild(e);var n=y.indexOf(e);n>=0&&y.splice(n,1)}function a(e){var n=document.createElement("style");return n.type="text/css",i(e,n),n}function s(e){var n=document.createElement("link");return n.rel="stylesheet",i(e,n),n}function d(e,n){var t,o,r;if(n.singleton){var i=w++;t=h||(h=a(n)),o=u.bind(null,t,i,!1),r=u.bind(null,t,i,!0)}else e.sourceMap&&"function"==typeof URL&&"function"==typeof URL.createObjectURL&&"function"==typeof URL.revokeObjectURL&&"function"==typeof Blob&&"function"==typeof btoa?(t=s(n),o=f.bind(null,t),r=function(){c(t),t.href&&URL.revokeObjectURL(t.href)}):(t=a(n),o=l.bind(null,t),r=function(){c(t)});return o(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap)return;o(e=n)}else r()}}function u(e,n,t,o){var r=t?"":o.css;if(e.styleSheet)e.styleSheet.cssText=b(n,r);else{var i=document.createTextNode(r),c=e.childNodes;c[n]&&e.removeChild(c[n]),c.length?e.insertBefore(i,c[n]):e.appendChild(i)}}function l(e,n){var t=n.css,o=n.media;if(o&&e.setAttribute("media",o),e.styleSheet)e.styleSheet.cssText=t;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))}}function f(e,n){var t=n.css,o=n.sourceMap;o&&(t+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(o))))+" */");var r=new Blob([t],{type:"text/css"}),i=e.href;e.href=URL.createObjectURL(r),i&&URL.revokeObjectURL(i)}var p={},v=function(e){var n;return function(){return"undefined"==typeof n&&(n=e.apply(this,arguments)),n}},m=v(function(){return/msie [6-9]\b/.test(window.navigator.userAgent.toLowerCase())}),g=v(function(){return document.head||document.getElementsByTagName("head")[0]}),h=null,w=0,y=[];e.exports=function(e,n){n=n||{},"undefined"==typeof n.singleton&&(n.singleton=m()),"undefined"==typeof n.insertAt&&(n.insertAt="bottom");var t=r(e);return o(t,n),function(e){for(var i=[],c=0;c<t.length;c++){var a=t[c],s=p[a.id];s.refs--,i.push(s)}if(e){var d=r(e);o(d,n)}for(var c=0;c<i.length;c++){var s=i[c];if(0===s.refs){for(var u=0;u<s.parts.length;u++)s.parts[u]();delete p[s.id]}}}};var b=function(){var e=[];return function(n,t){return e[n]=t,e.filter(Boolean).join("\n")}}()},,function(e,n,t){n=e.exports=t(1)(),n.push([e.id,".webrtc-div{margin-top:1em;text-align:center}.webrtc-button{margin-right:.5em}.font-size-12px{font-size:12px}.webrtc-remote-video,.webrtc-video-1{width:350px;height:240px}.webrtc-remote-video{margin-left:.1em}.webrtc{margin-bottom:3em}",""])},,,function(e,n,t){var o=t(4);"string"==typeof o&&(o=[[e.id,o,""]]),t(2)(o,{}),o.locals&&(e.exports=o.locals)}]);